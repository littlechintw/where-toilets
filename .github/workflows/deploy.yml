name: Deploy Website

on:
  # ç•¶ main åˆ†æ”¯çš„ç‰¹å®šæª”æ¡ˆç™¼ç”Ÿè®Šæ›´æ™‚è§¸ç™¼
  push:
    branches: [ main ]
    paths:
      - 'public/data/deploy-flag.json'  # è³‡æ–™æ›´æ–°æ¨™è¨˜æª”æ¡ˆ
      - 'src/**'                        # å‰ç«¯ç¨‹å¼ç¢¼è®Šæ›´
      - 'public/**'                     # éœæ…‹è³‡æºè®Šæ›´ï¼ˆé™¤äº†è³‡æ–™æª”æ¡ˆï¼‰
      - 'package.json'                  # ä¾è³´è®Šæ›´
      - 'vite.config.js'               # å»ºç½®è¨­å®šè®Šæ›´
      - '.github/workflows/deploy.yml' # å·¥ä½œæµç¨‹è‡ªèº«è®Šæ›´

  # æ‰‹å‹•è§¸ç™¼éƒ¨ç½²
  workflow_dispatch:
    inputs:
      reason:
        description: 'éƒ¨ç½²åŸå› '
        required: false
        default: 'æ‰‹å‹•è§¸ç™¼éƒ¨ç½²'
        type: string

# è¨­å®šæ¬Šé™
permissions:
  contents: read
  pages: write
  id-token: write

# ç¢ºä¿åŒæ™‚é–“åªæœ‰ä¸€å€‹éƒ¨ç½²å·¥ä½œæµç¨‹åŸ·è¡Œ
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # æª¢æŸ¥æ˜¯å¦éœ€è¦éƒ¨ç½²
  check-deploy:
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.check.outputs.should-deploy }}
      deploy-reason: ${{ steps.check.outputs.reason }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Check deployment trigger
      id: check
      run: |
        SHOULD_DEPLOY="false"
        REASON="æœªçŸ¥åŸå› "
        
        # æª¢æŸ¥æ˜¯å¦æœ‰ deploy-flag.json
        if [[ -f "public/data/deploy-flag.json" ]]; then
          echo "ç™¼ç¾è³‡æ–™æ›´æ–°æ¨™è¨˜æª”æ¡ˆ"
          SHOULD_DEPLOY="true"
          REASON="è³‡æ–™æ›´æ–°è§¸ç™¼"
        fi
        
        # æª¢æŸ¥æ˜¯å¦ç‚ºæ‰‹å‹•è§¸ç™¼
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "æ‰‹å‹•è§¸ç™¼éƒ¨ç½²"
          SHOULD_DEPLOY="true"
          REASON="${{ github.event.inputs.reason }}"
        fi
        
        # æª¢æŸ¥æ˜¯å¦æœ‰ç¨‹å¼ç¢¼è®Šæ›´
        if [[ "${{ github.event_name }}" == "push" ]]; then
          # æª¢æŸ¥æœ¬æ¬¡ push æ˜¯å¦åŒ…å«ç¨‹å¼ç¢¼ç›¸é—œæª”æ¡ˆ
          git diff --name-only HEAD^ HEAD | grep -E "(src/|package\.json|vite\.config\.js)" > /dev/null
          if [[ $? -eq 0 ]]; then
            echo "ç¨‹å¼ç¢¼è®Šæ›´è§¸ç™¼éƒ¨ç½²"
            SHOULD_DEPLOY="true"
            REASON="ç¨‹å¼ç¢¼æ›´æ–°"
          fi
        fi
        
        echo "should-deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
        echo "reason=$REASON" >> $GITHUB_OUTPUT
        echo "éƒ¨ç½²æ±ºå®š: $SHOULD_DEPLOY ($REASON)"

  # å»ºç½®å’Œéƒ¨ç½²ä½œæ¥­
  build-and-deploy:
    runs-on: ubuntu-latest
    needs: [check-deploy]
    if: needs.check-deploy.outputs.should-deploy == 'true'
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build application
      run: npm run build
    
    - name: Remove deploy flag after successful build
      run: |
        if [[ -f "public/data/deploy-flag.json" ]]; then
          echo "ç§»é™¤éƒ¨ç½²æ¨™è¨˜æª”æ¡ˆ"
          rm -f public/data/deploy-flag.json
        fi
    
    - name: Setup Pages
      uses: actions/configure-pages@v4
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './dist'
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      with:
        cname: toilets.littlechin.tw
    
    - name: Clean up deploy flag from repository
      if: always()
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # å¦‚æœ deploy-flag.json ä»å­˜åœ¨ï¼Œå°‡å…¶å¾ repository ä¸­ç§»é™¤
        if [[ -f "public/data/deploy-flag.json" ]]; then
          git rm public/data/deploy-flag.json
          git commit -m "ğŸ§¹ Remove deploy flag after deployment" || echo "No deploy flag to remove"
          git push || echo "Nothing to push"
        fi
    
    - name: Deployment summary
      run: |
        echo "âœ… ç¶²ç«™éƒ¨ç½²å®Œæˆï¼"
        echo "ğŸ”— ç¶²ç«™ç¶²å€: https://toilets.littlechin.tw"
        echo "ğŸ“… éƒ¨ç½²æ™‚é–“: $(date +'%Y-%m-%d %H:%M:%S')"
        echo "ğŸš€ è§¸ç™¼åŸå› : ${{ needs.check-deploy.outputs.deploy-reason }}"
        echo "ğŸ“Š æäº¤: ${{ github.sha }}"

  # éƒ¨ç½²å¤±æ•—è™•ç†
  handle-failure:
    runs-on: ubuntu-latest
    needs: [check-deploy, build-and-deploy]
    if: always() && needs.check-deploy.outputs.should-deploy == 'true' && needs.build-and-deploy.result == 'failure'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Handle deployment failure
      run: |
        echo "âŒ éƒ¨ç½²å¤±æ•—ï¼"
        echo "ğŸ” æª¢æŸ¥å»ºç½®æ—¥èªŒä»¥äº†è§£éŒ¯èª¤åŸå› "
        echo "â° å¤±æ•—æ™‚é–“: $(date +'%Y-%m-%d %H:%M:%S')"
        
        # å¯é¸ï¼šç™¼é€é€šçŸ¥æˆ–å»ºç«‹ Issue
        # é€™è£¡å¯ä»¥åŠ å…¥ Slack é€šçŸ¥ã€Email æˆ–å»ºç«‹ GitHub Issue çš„é‚è¼¯
