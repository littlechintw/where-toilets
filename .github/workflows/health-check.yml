name: Health Check

on:
  # æ¯å¤©æª¢æŸ¥ä¸€æ¬¡ç¶²ç«™ç‹€æ…‹
  schedule:
    - cron: '0 6 * * *'  # æ¯å¤© UTC 6 é»ï¼ˆå°ç£æ™‚é–“ä¸‹åˆ 2 é»ï¼‰
  
  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:

permissions:
  contents: read

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Check website status
      run: |
        echo "ğŸ” æª¢æŸ¥ç¶²ç«™å¥åº·ç‹€æ…‹..."
        
        # æª¢æŸ¥ä¸»é é¢
        if curl -f -s -o /dev/null "https://toilets.littlechin.tw/"; then
          echo "âœ… ä¸»é é¢æ­£å¸¸"
        else
          echo "âŒ ä¸»é é¢ç„¡æ³•è¨ªå•"
          exit 1
        fi
        
        # æª¢æŸ¥åœ°åœ–é é¢
        if curl -f -s -o /dev/null "https://toilets.littlechin.tw/map"; then
          echo "âœ… åœ°åœ–é é¢æ­£å¸¸"
        else
          echo "âš ï¸ åœ°åœ–é é¢å¯èƒ½æœ‰å•é¡Œï¼ˆSPA è·¯ç”±å•é¡Œç‚ºæ­£å¸¸ç¾è±¡ï¼‰"
        fi
        
        # æª¢æŸ¥è³‡æ–™ç´¢å¼•æª”æ¡ˆ
        if curl -f -s -o /dev/null "https://toilets.littlechin.tw/data/index.json"; then
          echo "âœ… è³‡æ–™ç´¢å¼•æª”æ¡ˆæ­£å¸¸"
        else
          echo "âŒ è³‡æ–™ç´¢å¼•æª”æ¡ˆç„¡æ³•è¨ªå•"
          exit 1
        fi
        
        echo "ğŸ‰ å¥åº·æª¢æŸ¥å®Œæˆ"
    
    - name: Check data freshness
      run: |
        echo "ğŸ“… æª¢æŸ¥è³‡æ–™æ–°é®®åº¦..."
        
        # ä¸‹è¼‰ç´¢å¼•æª”æ¡ˆæª¢æŸ¥æ›´æ–°æ™‚é–“
        curl -s "https://toilets.littlechin.tw/data/index.json" > index.json
        
        if [[ -f index.json ]]; then
          last_updated=$(cat index.json | grep -o '"last_updated":"[^"]*' | cut -d'"' -f4)
          echo "ğŸ“Š è³‡æ–™æœ€å¾Œæ›´æ–°æ™‚é–“: $last_updated"
          
          # æª¢æŸ¥æ˜¯å¦è¶…é 10 å¤©æœªæ›´æ–°
          if [[ -n "$last_updated" ]]; then
            last_timestamp=$(date -d "$last_updated" +%s 2>/dev/null || echo "0")
            current_timestamp=$(date +%s)
            days_diff=$(( (current_timestamp - last_timestamp) / 86400 ))
            
            echo "ğŸ“ˆ è³‡æ–™å·² $days_diff å¤©æœªæ›´æ–°"
            
            if [[ $days_diff -gt 10 ]]; then
              echo "âš ï¸ è³‡æ–™è¶…é 10 å¤©æœªæ›´æ–°ï¼Œå»ºè­°æª¢æŸ¥è‡ªå‹•æ›´æ–°æµç¨‹"
            else
              echo "âœ… è³‡æ–™æ›´æ–°æ™‚é–“æ­£å¸¸"
            fi
          fi
        fi