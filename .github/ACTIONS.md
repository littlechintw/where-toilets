# GitHub Actions 工作流程說明

本專案使用三個獨立的 GitHub Actions 工作流程來管理不同的任務：

## 📊 update-data.yml - 資料更新流程

**觸發條件：**
- 每週日 UTC 0 點自動執行
- 手動觸發（可選擇強制更新）

**執行內容：**
1. 從環保署 API 抓取最新廁所資料
2. 正規化資料並按縣市分檔
3. 檢查資料是否有實質變更
4. 如有變更，建立 `deploy-flag.json` 標記檔案
5. 提交並推送變更到 repository

**注意事項：**
- 需要在 Repository Secrets 中設定 `MOENV_API_KEY`
- 只有在資料真正有變更時才會觸發後續部署
- 如果選擇強制更新，即使資料無變更也會觸發部署

## 🚀 deploy.yml - 網站部署流程

**觸發條件：**
- `deploy-flag.json` 檔案變更（資料更新觸發）
- 前端程式碼變更（`src/`、`package.json`、`vite.config.js`）
- 靜態資源變更（`public/` 除了資料檔案）
- 手動觸發

**執行內容：**
1. 檢查部署觸發原因
2. 建置 Vue 應用程式
3. 部署到 GitHub Pages
4. 清理部署標記檔案

**優勢：**
- 專職負責網站部署，職責單一
- 智慧判斷是否需要部署
- 自動清理臨時標記檔案

## 🏥 health-check.yml - 健康檢查流程

**觸發條件：**
- 每天 UTC 6 點自動執行
- 手動觸發

**執行內容：**
1. 檢查網站主頁面可訪問性
2. 檢查資料索引檔案狀態
3. 檢查資料新鮮度（超過 10 天會警告）

**用途：**
- 監控網站健康狀態
- 及早發現問題
- 確保資料定期更新

## 🔄 工作流程關係圖

```
┌─────────────────┐    數據變更    ┌─────────────────┐
│   update-data   │───────────────▶│     deploy      │
│   (週日執行)     │  deploy-flag   │   (自動觸發)     │
└─────────────────┘                └─────────────────┘
         │                                   │
         │                                   │
         ▼                                   ▼
┌─────────────────┐                ┌─────────────────┐
│ GitHub Repo     │                │ GitHub Pages    │
│ (數據檔案)       │                │ (網站)          │
└─────────────────┘                └─────────────────┘
         │                                   │
         │                                   │
         ▼                                   ▼
┌─────────────────┐                ┌─────────────────┐
│  health-check   │                │     使用者      │
│   (每日檢查)     │                │                │
└─────────────────┘                └─────────────────┘
```

## 📝 手動操作指南

### 強制更新資料
1. 前往 Actions 頁面
2. 選擇 "Update Toilet Data"
3. 點擊 "Run workflow"
4. 勾選 "強制更新資料"
5. 點擊 "Run workflow"

### 手動部署網站
1. 前往 Actions 頁面
2. 選擇 "Deploy Website"
3. 點擊 "Run workflow"
4. 填寫部署原因（可選）
5. 點擊 "Run workflow"

### 檢查網站健康狀態
1. 前往 Actions 頁面
2. 選擇 "Health Check"
3. 點擊 "Run workflow"
4. 查看執行結果

## 🔧 設定需求

### Repository Secrets
- `MOENV_API_KEY`: 環保署 API 金鑰

### GitHub Pages
- 啟用 GitHub Pages
- 選擇 "GitHub Actions" 作為 Source

### 分支保護（建議）
- 啟用 main 分支保護
- 要求 Actions 檢查通過才能合併

## ⚠️ 故障排除

### 資料更新失敗
- 檢查 API 金鑰是否正確
- 檢查環保署 API 是否正常
- 查看 Actions 日誌的錯誤訊息

### 部署失敗
- 檢查建置過程是否有錯誤
- 確認 GitHub Pages 設定正確
- 檢查是否有語法錯誤

### 健康檢查失敗
- 確認網站是否可正常訪問
- 檢查資料檔案是否存在
- 確認 DNS 設定是否正確

## 📈 監控建議

建議定期檢查：
1. Actions 執行狀態
2. 網站可訪問性
3. 資料更新頻率
4. 建置時間是否正常

透過這種分離式設計，每個工作流程都有明確的職責，更容易維護和除錯。